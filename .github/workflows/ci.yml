name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Check (${{ matrix.platform.name }})
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: macOS-arm64
            os: macos-14
            target: aarch64-apple-darwin
          - name: macOS-x64
            os: macos-13
            target: x86_64-apple-darwin
          - name: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: Linux
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Whisper models
        shell: bash
        run: |
          mkdir -p src-tauri/models
          # Simplified naming without quantization suffix for easier maintenance
          curl -L -o src-tauri/models/ggml-small.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin"
          curl -L -o src-tauri/models/ggml-large-v3-turbo.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-large-v3-turbo-q5_0.bin"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libssl-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            rpm \
            wget

          # Install Vulkan SDK (includes glslc compiler required by whisper-rs)
          VULKAN_VERSION=1.3.283.0
          wget -qO - https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-${VULKAN_VERSION}-jammy.list \
            https://packages.lunarg.com/vulkan/${VULKAN_VERSION}/lunarg-vulkan-${VULKAN_VERSION}-jammy.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk

      - name: Install Windows dependencies
        if: matrix.platform.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "Installing CMake and Ninja..."
          choco install cmake ninja -y --no-progress

          Write-Host "Downloading Vulkan SDK..."
          $vulkanVersion = "1.4.304.0"
          $vulkanUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
          $installerPath = "$env:TEMP\VulkanSDK-Installer.exe"

          Invoke-WebRequest -Uri $vulkanUrl -OutFile $installerPath

          Write-Host "Installing Vulkan SDK..."
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow

          # Set VULKAN_SDK environment variable
          $vulkanPath = "C:\VulkanSDK\$vulkanVersion"
          if (Test-Path $vulkanPath) {
            echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV
            $env:VULKAN_SDK = $vulkanPath
            Write-Host "✅ VULKAN_SDK set to: $vulkanPath"
          } else {
            Write-Host "❌ Vulkan SDK installation failed!"
            exit 1
          }

      - name: Install frontend dependencies
        run: npm ci

      - name: Check TypeScript
        run: npm run build

      - name: Check Rust
        working-directory: src-tauri
        run: cargo check --target ${{ matrix.platform.target }}

  lint:
    name: Lint
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Whisper models
        run: |
          mkdir -p src-tauri/models
          # Simplified naming without quantization suffix for easier maintenance
          curl -L -o src-tauri/models/ggml-small.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small-q5_1.bin"
          curl -L -o src-tauri/models/ggml-large-v3-turbo.bin \
            "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-large-v3-turbo-q5_0.bin"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libssl-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            rpm \
            wget

          # Install Vulkan SDK (includes glslc compiler required by whisper-rs)
          VULKAN_VERSION=1.3.283.0
          wget -qO - https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-${VULKAN_VERSION}-jammy.list \
            https://packages.lunarg.com/vulkan/${VULKAN_VERSION}/lunarg-vulkan-${VULKAN_VERSION}-jammy.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Rust format check
        working-directory: src-tauri
        run: cargo fmt --check

      - name: Rust clippy
        working-directory: src-tauri
        run: cargo clippy -- -D warnings
